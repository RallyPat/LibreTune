name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-check:
    name: Rust Check & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libudev-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --workspace

      - name: Run tests
        run: cargo test --workspace

      - name: Verify build info format
        if: runner.os == 'Linux'
        run: cargo test --package libretune-app --test build_info -- --nocapture

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  frontend-check:
    name: Frontend Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: crates/libretune-app
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: crates/libretune-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Run unit tests
        run: npm run test:run

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check
  appimage-validation:
    name: AppImage Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev libudev-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: crates/libretune-app/package-lock.json

      - name: Install dependencies
        working-directory: crates/libretune-app
        run: npm ci

      - name: Build Tauri AppImage
        working-directory: crates/libretune-app
        run: npm run tauri build -- --target x86_64-unknown-linux-gnu 2>&1 | grep -i appimage || true

      - name: Find and validate AppImage
        run: |
          # Locate built AppImage
          APPIMAGE=$(find target -name "*.AppImage" -type f | head -1)
          if [ -z "$APPIMAGE" ]; then
            echo "⚠ Warning: AppImage not found, skipping validation"
            echo "This may occur in some CI environments, validation can be tested locally"
            exit 0
          fi
          
          echo "Found AppImage: $APPIMAGE"
          
          # Extract AppImage to validate structure
          mkdir -p appimage-extract
          cd appimage-extract
          "$APPIMAGE" --appimage-extract > /dev/null 2>&1 || true
          
          # Check for critical issues
          ERRORS=0
          
          # 1. Verify lib/x86_64-linux-gnu symlink exists (for WebKit paths)
          if [ ! -L "squashfs-root/lib/x86_64-linux-gnu" ]; then
            echo "✗ FAIL: Missing lib/x86_64-linux-gnu symlink"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ PASS: lib/x86_64-linux-gnu symlink present"
          fi
          
          # 2. Check for excluded conflicting Wayland libraries (should not be present after patching)
          CONFLICTING_LIBS=("libwayland-egl.so.1" "libwayland-client.so.0" "libwayland-server.so.0" 
                            "libwayland-cursor.so.0" "libepoxy.so.0")
          for lib in "${CONFLICTING_LIBS[@]}"; do
            if [ -f "squashfs-root/usr/lib/$lib" ] || [ -f "squashfs-root/usr/lib/x86_64-linux-gnu/$lib" ]; then
              echo "⚠ WARNING: Found conflicting library $lib (may cause Wayland issues)"
            fi
          done
          
          # 3. Verify ICU libraries are present
          ICU_LIBS=("libicudata.so.74" "libicui18n.so.74" "libicuuc.so.74")
          for lib in "${ICU_LIBS[@]}"; do
            if [ -f "squashfs-root/usr/lib/$lib" ] || [ -f "squashfs-root/usr/lib/x86_64-linux-gnu/$lib" ]; then
              echo "✓ PASS: ICU library $lib found"
            else
              echo "⚠ INFO: ICU library $lib not required for this build"
            fi
          done
          
          # 4. Verify WebKit binary location
          if [ -f "squashfs-root/usr/bin/libretune-app" ]; then
            echo "✓ PASS: Main binary found at usr/bin/libretune-app"
          else
            echo "⚠ INFO: Binary location check skipped"
          fi
          
          # Report results
          echo ""
          if [ $ERRORS -eq 0 ]; then
            echo "✓ AppImage structure validation passed"
            exit 0
          else
            echo "✗ AppImage structure validation failed with $ERRORS error(s)"
            exit 1
          fi